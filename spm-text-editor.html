<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPM Text Preview</title>
  <link rel="stylesheet" href="stylesheet.css">
  <style>
    /* Custom font */
    @font-face {
      font-family: 'SPMText';
      src: url('PopJoyStd-B.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    /* Apply font */
    body, #output {
      font-family: 'SPMText', sans-serif;
    }

    /* fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    /* dynamic shrink animation */
    @keyframes dynamicShrink {
      from { transform: scale(var(--dyn-factor)); }
      to   { transform: scale(1); }
    }
    /* helper classes */
    .shake-letter { display:inline-block; animation:shake 0.15s infinite; }
    .wave-letter  { display:inline-block; animation:wave  0.9s  infinite; }
    .dynamic-letter {
      display: inline-block;
      transform: scale(var(--dyn-factor));
      animation-name: dynamicShrink;
      animation-duration: 0.05s;
      animation-fill-mode: forwards;
    }

    /* keyframes for shake & wave */
    @keyframes shake {
      0%   {transform:translate(0,0)rotate(0)}
      20%  {transform:translate(-0.5px,-0.5px)rotate(-1deg)}
      40%  {transform:translate(-0.5px,0.5px)rotate(1deg)}
      60%  {transform:translate(0.5px,0.5px)rotate(0)}
      80%  {transform:translate(0.5px,-0.5px)rotate(1deg)}
      100% {transform:translate(0,0)rotate(-1deg)}
    }
    @keyframes wave {
      0%   {transform:translateY(-3px)}
      50%  {transform:translateY(3px)}
      100% {transform:translateY(-3px)}
    }

    /* layout */
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      background: #f4f4f4;
    }
    textarea {
      width: 80%;
      height: 200px;
      margin-bottom: 1rem;
      font-family: monospace;
      font-size: 1rem;
      white-space: pre;
      resize: both;
    }
    #output {
      width: 80%;
      height: 150px;
      background: white;
      padding: 1rem;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      cursor: pointer;
      resize: both;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h1>Super Paper Mario Text Preview</h1>
  <textarea id="input" placeholder="Use formatting tags from Super Paper Mario! Supports &lt;shake&gt;, &lt;wave&gt;, &#10;&lt;scale x&gt;, &lt;dynamic 3&gt;, and &lt;wait x&gt;."></textarea>
  <div id="output" title="Click to advance"></div>

  <script>
    const inputArea = document.getElementById('input');
    const outputDiv = document.getElementById('output');
    let pages = [];
    let currentPage = 0;

    function createSpan(char, effects, scale, dynFactor, delay) {
      let node = document.createTextNode(char === ' ' ? '\u00A0' : char);
      if (effects.includes('shake')) {
        const shakeSpan = document.createElement('span');
        shakeSpan.className = 'shake-letter';
        shakeSpan.style.animationDelay = delay + 'ms';
        shakeSpan.appendChild(node);
        node = shakeSpan;
      }
      if (effects.includes('wave')) {
        const waveSpan = document.createElement('span');
        waveSpan.className = 'wave-letter';
        waveSpan.style.animationDelay = delay + 'ms';
        waveSpan.appendChild(node);
        node = waveSpan;
      }
      if (scale !== 1) {
        const scaleSpan = document.createElement('span');
        scaleSpan.style.display = 'inline-block';
        scaleSpan.style.fontSize = scale + 'em';
        scaleSpan.appendChild(node);
        node = scaleSpan;
      }
      if (dynFactor !== 1) {
        const dynSpan = document.createElement('span');
        dynSpan.className = 'dynamic-letter';
        dynSpan.style.setProperty('--dyn-factor', dynFactor);
        dynSpan.style.animationDelay = delay + 'ms';
        dynSpan.appendChild(node);
        node = dynSpan;
      }
      const fadeSpan = document.createElement('span');
      fadeSpan.style.display = 'inline-block';
      fadeSpan.style.opacity = '0';
      fadeSpan.style.animation = `fadeIn 0s forwards ${delay}ms`;
      fadeSpan.appendChild(node);
      return fadeSpan;
    }

    function parseCustomTags(text) {
      const frag = document.createDocumentFragment();
      const stack = [];
      let delayCount = 0;
      let extraDelay = 0;
      let i = 0;
      while (i < text.length) {
        const char = text[i];
        if (char === '\n') {
          frag.appendChild(document.createElement('br'));
          i++;
          continue;
        }
        if (char === '<') {
          const open = text.slice(i).match(/^<\s*(shake|wave|scale|dynamic|wait)\s*([^>]*)>/i);
          const close= text.slice(i).match(/^<\s*\/\s*(shake|wave|scale|dynamic)\s*>/i);
          if (open) {
            const tag = open[1].toLowerCase();
            const arg = parseFloat(open[2]) || 0;
            if (tag === 'wait') { extraDelay += arg; }
            else if (tag === 'scale' || tag === 'dynamic') { stack.push({type: tag, factor: arg}); }
            else { stack.push({type: tag}); }
            i += open[0].length;
            continue;
          } else if (close) {
            const tag = close[1].toLowerCase();
            for (let j = stack.length - 1; j >= 0; j--) {
              if (stack[j].type === tag) { stack.splice(j, 1); break; }
            }
            i += close[0].length;
            continue;
          }
        }
        const hasWave = stack.some(e => e.type === 'wave');
        const hasShake= stack.some(e => e.type === 'shake');
        const effects = [];
        if (hasWave) effects.push('wave');
        if (hasShake) effects.push('shake');
        const scale = stack.filter(e => e.type==='scale').reduce((s,e)=>s*e.factor,1);
        const dynFactor = stack.filter(e=>e.type==='dynamic').reduce((s,e)=>s*e.factor,1);
        const delay = delayCount * 25 + extraDelay;
        frag.appendChild(createSpan(char, effects, scale, dynFactor, delay));
        delayCount++;
        i++;
      }
      return frag;
    }

    function generatePages() {
      const raw = inputArea.value;
      const parts = raw.split(/\n\s*\n/);
      pages = parts.map(part => parseCustomTags(part));
      currentPage = 0;
    }

    function showPage(idx) {
      outputDiv.innerHTML = '';
      outputDiv.appendChild(pages[idx]);
    }

    function updatePreview() {
      generatePages();
      showPage(0);
    }

    outputDiv.addEventListener('click', () => {
      if (pages.length <= 1) return;
      if (currentPage < pages.length - 1) {
        currentPage++;
        showPage(currentPage);
      }
    });

    inputArea.addEventListener('input', updatePreview);
    updatePreview();
  </script>
</body>
</html>
